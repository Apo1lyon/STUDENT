#МоиЛекции #РаботаПК 

**Инструкции процессора** – это набор команд, которые выполняются процессором. Каждая инструкция содержит определенный код, который процессор распознает и выполняет соответствующую операцию. У каждого процессора есть свой набор инструкций, который определяет, какие команды он может выполнить. Но есть некоторые стандартные наборы инструкций, которые поддерживаются большинством процессоров на рынке.

Инструкции процессора определяют базовый набор операций, которые может выполнять процессор, такие как:

- Арифметические операции (сложение, вычитание, умножение, деление)
- Логические операции (AND, OR, XOR, NOT)
- Операции сравнения (равно, больше, меньше)
- Операции загрузки и сохранения данных в память
- Операции передачи данных между регистрами процессора и внешними устройствами
- Управления переходом и выполнением инструкций (ветвление, вызовы функций)

При разработке программного обеспечения необходимо учитывать возможности и ограничения аппаратной платформы, включая набор инструкций процессора. Некоторые инструкции могут выполняться быстрее, чем другие, поэтому разработчики могут использовать определенные оптимизации кода, чтобы оптимизировать производительность программы. Кроме того, некоторые инструкции могут быть недоступны на определенных процессорах, поэтому программист должен учитывать совместимость со всеми целевыми аппаратными платформами при разработке программного обеспечения.

Одним из наиболее распространенных наборов инструкций является x86. Он используется в процессорах Intel и AMD, которые являются самыми распространенными компьютерными процессорами в мире. x86 поддерживает широкий диапазон операций, включая арифметические, логические, условные операции, операции ввода-вывода и многое другое. Этот набор инструкций является довольно старым и имеет множество дополнительных инструкций, добавленных за десятилетия исследований и разработок.

> x86 - архитектура процессоров и одноименный набор команд, впервые реализованные в процессорах компании Intel. Название образовано от двух цифр, которыми заканчивались названия процессоров Intel ранних моделей — 8086, 80186, 80286

Другим набором инструкций, который становится все более популярным, является ARM. Он используется в большинстве смартфонов, планшетов и других мобильных устройств. ARM является более современным набором инструкций, который разработан с учетом энергоэффективности и меньшего размера процессора. Он также поддерживает широкий диапазон операций, которые аналогичны x86.

---
## ARM

Это сокращение от **Advanced RISC Machine** (расшифровка по-русски звучит как "Усовершенствованный комплекс управления сокращенной командой"). Он используется в большинстве мобильных устройств, таких как смартфоны, планшеты, ноутбуки и электронные книги, а также в некоторых встраиваемых системах и серверной аппаратуре.

ARM является RISC-процессором, что означает, что он использует набор инструкций сокращенной команды (CISC - набор инструкций со сложными командами). Это делает его более энергоэффективным, чем CISC-процессоры, такие как x86, потому что он выполняет больше операций с меньшим количеством команд. ARM-процессоры также имеют более маленький размер, что позволяет их использовать в устройствах с ограниченным местом.

ARM также поддерживает широкий диапазон операций, которые аналогичны x86, что делает его более гибким для разработки программного обеспечения. Он также имеет возможность использования многопоточности, что позволяет ему быстро обрабатывать несколько задач одновременно.

Инструкции процессора не появляются из ниоткуда. Они обычно разрабатываются производителями процессоров в течение многих лет, исследуя и улучшая наборы инструкций, которые использовались ранее. Кроме того, существует ряд отраслевых организаций, таких как ARM Holdings, которые занимаются разработкой стандартных наборов инструкций.

---
## Блоки процессора

Для более детального рассмотрения архитектуры процессора, в качестве примера мы рассмотрим процессор 6502 и будем опираться на его фундамент, чтобы представить некоторые функциональные компоненты, широко используемые в процессорных архитектурах - от самых крошечных встроенных контролеров до самых мощных серверных процессорах.

Перед тем как мы разберём выполнение инструкций более подробно, следует разобрать три логически различных функциональных блока из которых состоит процессор:

- **Устройство управления** осуществляет общее управление работой процессора. Процесс управления включает в себя извлечение следующей инструкции из памяти, декодирование инструкции для определения операции, которую требуется выполнить, и распределение действий по выполнению инструкций между соответствующими элементами процессора.
- **Арифметико-логическое устройство (АЛУ)** - это комбинационная схема, которая выполняет арифметические операции и операции с битами.
- **Набор регистров** представляет исходные и конечные местоположения для хранения входных и выходных данных инструкции. Регистры также используются в качестве мест для временного хранения данных.

![[Pasted image 20231204025122.png]]

На рисунке показаны потоки управления и данных между устройством управления, регистрами, АЛУ, системной памятью и устройствами ввода-вывода.

Устройство управления управляет общими операциями процессора для выполнения каждой инструкции. Регистры, АЛУ, память и устройства ввода-вывода реагируют на команды, инициируемые устройством управления.

### Устройство управления

Устройство управления современного процессора представляет собой синхронную последовательную цифровую схему. Оно интерпретирует инструкции процессора и управляет выполнением этих инструкций, взаимодействуя с другими функциональными блоками внутри процессора и с внешними компонентами, включая память и устройство ввода-вывода. Устройство управления является ключевой частью архитектуры фон Наймана.

В этой теме термин "память" относиться к **оперативному запоминающему устройству (ОЗУ, оперативная память)**, являющемуся внешним по отношению к исполнительным блокам процессора. Кэш-память, которая часто располагается на интегрированной схеме микропроцессора, будет рассмотрена в следующих темах.

Некоторые примеры устройств ввода-вывода: компьютерная клавиатура, мышь, дисковый накопитель и монитор. Другие распространенные устройства ввода-вывода: сетевые интерфейсы, интерфейсы беспроводной связи Wi-Fi и Bluethooth, аудиовыход на динамики и микрофонный выход.

После включения компьютера система процессора выполняет процедуру сброса для инициализации своих внутренних компонентов. Затем процессор загружает в **программный счетчик (ПС)** адрес ячейки памяти первой инструкции, которая должна быть выполнена. 

> Разработчики программного обеспечения, создающие системные программные компоненты самого низкого уровня, должны настроить свои средства разработки для создания образа кода в памяти, выполнение которого начинается по адресу, требуемому архитектурой компьютера. 

ПС является центральным компонентом устройства управления. Он всегда содержит адрес инструкции, которая должна быть выполнена следующей. В начале каждого цикла выполнения инструкции устройство управления считывает слово данных из ячейки памяти по адресу, указанному ПС, и помещает его во внутренний регистр для декодирования и выполнения. 

Первое слово инструкции содержит **код операции (опкод)**. На основе битового шаблона опкода устройство управления может считывать дополнительные ячейки памяти, следующие за опкодом, для извлечения данных, требуемых инструкцией, такие как адреса ячейки памяти или операнд данных.

![[instruction.jpg]]

Когда устройство управления начинает выполнять инструкции, оно работает в повторяющемся цикле, показанном на схеме ниже.

![[Pasted image 20231204031944.png]]

Также в ходе процесса декодирования устройство управления определяет категорию инструкции. Представлены две категории инструкций - **инструкции ветвления и все прочие инструкции.**

Инструкция ветвления реализуются непосредственно устройством управления. Они вызывают замену содержимого ПС адресом ячейки памяти для выполнения ветви. Примеры инструкций, выполняющих ветвление: инструкции условного ветвления  (когда осуществляется выбор ветви), вызовы подпрограмм, возвраты из подпрограмм и инструкции безусловного ветвления (также называемые *переходами*)

Инструкции не предусматривающие ветвления, выполняются схемой процессора под контролем устройства управления.

Процесс выполнения команды может включать в себя такие действия, как чтение или запись регистра, чтение или запись ячейки памяти, указание АЛУ выполнить математическую операцию и другие действия.
В большинстве процессоров выполнение одной инструкции занимает несколько тактовых циклов. Количество циклов для выполнения инструкции может меняться в широких пределах - от простых инструкций, требующих небольшого количества тактов, до сложных операций, выполнение которых занимает много циклов. Устройство управления координирует всю эту деятельность.

Схемы, управляемые устройством управления построены из простых логических вентилей и часто включают в себе элементы более высокого уровня, такие как мультиплексоры, защелки и триггеры. Мультиплексоры, в частности, обычно используются логикой устройства управления для выборочной маршрутизации данных в заданное место назначения. 

### Арифметико-логическое устройство (ALU)

**Арифметико-логическое устройство** (ALU) блок процессора, который выполняет арифметические и битовые операции под управлением **устройства управления**. 

Для выполнения операций АЛУ требует ввода значений данных, называемые **операндами**, вместе с кодом , указывающим на операцию, которая должна быть выполнена. Разрядность операндов обычно называют размером или длиной **машинного слова**. Выходные данные АЛУ, являются результатом операции. 

Операции АЛУ могут использовать в качестве входных данных один или несколько *флагов процессора*, такие как флаг переноса, а также устанавливать состояния флагов процессора в качестве выходных данных. В процессоре 6502 операции АЛУ меняют состояние флагов переноса, отрицания, нуля и переполнения.

> **Операнда** - данные, которые обрабатываются командой.
> **Машинное слово** - единица данных, которая выбрана естественной для данной архитектуры процессора. В большинстве **случаев** оно равно 8 битам.

Концепция арифметико-логического устройства предложена в 1945 году Джоном фон Нейманом; она стала одной из составляющих ставшей классической фон-неймановской компьютерной архитектуры.

![[Pasted image 20231208115039.png]]

**АЛУ** - это комбинационная схема, которая подразумевает, что её выходы обновляются асинхронно (в разные моменты времени), реагируя на изменения на входах. Кроме того, это устройство не сохраняет данные о предыдущих операциях. 

Для того чтобы выполнить инструкцию, затрагивающую АЛУ, устройство управления передает в АЛУ входные данные, выдерживая паузу, чтобы учесть задержку прохождения сигнала по цепям АЛУ, а затем передает выходные данные АЛУ по адресу, указанному инструкцией.

АЛУ содержит схему сумматора для выполнения операции сложения и вычитания. В процессоре с арифметикой в дополнительном коде вычитание можно реализовать путем выполнения отрицания в дополнительном коде для первого операнда и добавления результата к левому операнду. 

>**С математической точки  зрения, при выполнении вычитания таким образом выражение *A - B* преобразуется в *A + (-B)*.**

Отрицание в дополнительном коде для числа со знаком выполняется путем инвертирования всех битов в операнде и добавления 1 к результату. 

| Десятичное значение| Двоичное значение | Инверсия битов | Добавление единицы | Результат отрицания |
| ---------- | --------- | ---------- | --------- | --------- |
| 0 | 00000000b | 11111111b | 00000000b | 0 |
| 1 | 00000001b | 11111110b | 11111111b | -1 |
| -1 | 11111111b | 00000000b | 00000001b | 1 |
| 127 | 01111111b | 10000000b | 10000001b | -127 |
| -127 | 10000001b | 01111110b | 01111111b | 127 |

С учетом этой операции вычитание, представленное в виде **A + (-B)**, превращается в **A + (NOT(B) + 1)**
 
 Рассмотрение вычитания в этой форме должно прояснить использование флага переноса в процессоре 6502 в сочетании с инструкцией *SBC* (сложение или вычитание двух операндов со входом переноса). Когда заимствование при вычитании отсутствует, флаг **C** (флаг, указывающий на наличие переноса при сложении (C = 1) или заимствования при вычитании (C = 0)) обеспечивает добавление 1. При наличии заимствования сумма должна быть уменьшена на 1, что достигается путем обнуления флага **C**.

Подводя итог, можно сказать, что в процессоре 6502 логика вычитания идентична логике сложения с тем единственным отличием, что операнд **B** в выражении **A - B** пропускается через набор вентилей НЕ для инвертирования всех восьми битов перед подачей значения НЕ(В) на вход сумматора. 

Схематически данное функциональное представление операции сложения и вычитания будет выглядеть следующим образом:

![[Pasted image 20240108222202.png]]

### Регистры 

**Регистры процессора** - это внутренние области хранения данных, которые выполняют функции источников и мест назначения для операции, используемых для выполнения инструкций. Регистры обеспечивают наиболее быстрый доступ к данным в процессоре, но ограничены очень небольшим количеством ячеек памяти из-за их высокой стоимости с точки зрения площадь матрицы. Разрядность регистра обычно совпадает с размером слова процессора.

При разработке новой архитектуры процессора крайне важно найти золотую середину между количеством регистров и количеством и сложностью инструкций, доступных процессору. Если взять кристалл интегральной схемы определённого размера и определенной технологии изготовления (оба этих фактора ограничивают количество транзисторов доступных для процессора), то добавление большего числа регистров в архитектуру уменьшает количество транзисторов, доступных для выполнения инструкций и других функций. С другой стороны, добавление инструкций со сложными возможностями способно ограничить пространство кристалла, доступное для регистров.  Это противоречие между сложностью наборов инструкций и количеством регистров выражается в отнесении архитектуры к категории CISC или RISC.

- Процессоры категории **CISC (complex instruction set computer - компьютер с полным набором инструкций)** характеризуется наличием обширного набора инструкций, поддерживающего множество функций, таких как возможность загружать операнды из памяти, выполнять операцию и сохранять результат в памяти, и все это с помощью одной инструкции. В процессоре CISC выполнение инструкции может занять много тактов, пока процессор выполняет все необходимые подзадачи. Процессор CISC, как правило, имеет меньшее количество регистров, отчасти из-за того, что значительную площадь кристалла занимают схемные элементы, реализующие логику набора инструкций. Семейство процессоров *x86* является классическим примером архитектуры CISC. 
- Процессоры категории **RISC (reduced instruction set computer - компьютер с сокращенным набором инструкций)**, напротив имеет меньшее количество инструкций, каждая из которых выполняет более простые задачи по сравнению с инструкциями процессора CISC. Выполнение операции со значениями данных, хранящимися в памяти, может потребовать пары инструкций для загрузки двух операндов из памяти в регистры, ещё одной инструкции для выполнения операции и заключительной инструкции для записи результата операции в память.

Ключевое различие между CISC и RISC заключается в том, что архитектуры RISC оптимизированы для выполнения отдельных инструкций с очень высокой скоростью. Несмотря на то что в RISC-процессоре для чтения данных из памяти, выполнение операции и записи результата в память требуется на несколько инструкций больше, чем в CISC-процессоре, общее время от начала до конца выполнения тех же операций может быть сопоставимым или даже меньшим в случаи RISC-процессора. Примерами категории RISC может служить архитектура ARM.

---
## Выполнение инструкции

Как мы уже успели выяснить, процессор является весьма мощным инструментом благодаря своей программируемости. Каждый процессор имеет набор базовых инструкций, которые собираются в определённую последовательность для выполнения конкретной задачи. Для более ясного понимания того, как процессор выполняет свои инструкции мы отойдём от примера с инструкциями процессора 6502 и напишем свою последовательность инструкций, для выполнения нужной нам задачи. 

> **Процессор - это аппаратное обеспечение (harware) которое управляется программным обеспечением (software).**

Представим, что у нас есть следующий набор инструкций процессора:

| Инструкция | Описание | Код операции | Адрес или регистр | 
| ---------- | --------- | ---------- | --------- | 
| Load_A | Считывание местоположения оперативной памяти (ОЗУ) в регистр A | 0010 | 4-бита адреса оперативной памяти| 
| Load_B | Считывание местоположения оперативной памяти (ОЗУ) в регистр В | 0001 | 4-бита адреса оперативной памяти | 
| Store_A | Считывание из регистра A в оперативную память (ОЗУ)  | 0100 | 4-бита адреса оперативной памяти | 
| Add | Сложить два регистра и записать значение во второй регистре | 1000 | 2-бита идентификатора регистра & 2-бита идентификатора регистра | 

И оперативная память (ОЗУ) компьютера,  из которой мы будем брать наши адреса и инструкции процессора:

| Адрес | Данные | 
| ---------- | --------- |
| 0 | 00101110 |
| 1 | 00011111 |
| 2 | 10000100|
| 3 | 01001101| 
| 4 | 00000000 |
| 5 | 00000000 |
| 6 | 00000000|
| 7 | 00000000| 
| 8 | 00000000 |
| 9 | 00000000 |
| 10 | 00000000|
| 11 | 00000000| 
| 12 | 00000000 |
| 13 | 00000000 |
| 14 | 00000011|
| 15 | 00001110| 
| ... | ... | 

Инструкции хранятся в ОЗУ в последовательном порядке. Для гипотетического процессора инструкция состоит из **опкода** и **адреса памяти/регистра**. Внутри управляющего устройства есть два регистра инструкций, в которые загружается опкод и адрес текущей исполняемой команды. Ещё в процессоре есть дополнительные регистры, которые хранят в себе последние 4 бита выполненных инструкций.

Так как процессор только начал свою работу, он загружает в ПС адрес ячейки памяти первой инструкции. Первые четыре бита (первый разряд) инструкции являются нашим опкодом, последние четыре бита (второй разряд) инструкции - адресом.

| Первый разряд | Второй разряд | 
|---------- | -------- |
| 0010 | 1110 |

Зная эту информацию, мы можем для себя записать эти биты в виде инструкции и адреса.

| Первый разряд | Второй разряд | 
|---------- | -------- |
| Load_A | 14 |

Теперь необходимо проделать тоже самое с остальными данными хранящимися в оперативной памяти.

| Адрес | Данные | 
| ---------- | --------- |
| 0 | Load_A 14 |
| 1 | Load_B 15 |
| 2 | Add B A|
| 3 | Store_A 13| 
| 4 | 0 |
| 5 | 0 |
| 6 | 0|
| 7 | 0| 
| 8 | 0 |
| 9 | 0 |
| 10 | 0|
| 11 | 0| 
| 12 | 0 |
| 13 | 0 |
| 14 | 3|
| 15 | 14| 
| ... | ... | 

Отлично, теперь мы знаем в какой последовательности процессор будет читать и выполнять инструкции. Разберём все инструкции в памяти по порядку:

1. Процессор считывает значение из ячейки **по адресу 14** и сохраняет значение в **регистре А**.

![[Pasted image 20231204040350.png]]

2. Процессор считывает значение из ячейки **по адресу 15** и сохраняет значение в **регистре В**.

![[Pasted image 20231204040536.png]]

3. Процессор просит **АЛУ** сложить два регистра вместе, и записать результат в **регистре А**.

![[Pasted image 20231204040615.png]]

4. Взять получившееся значение **из регистра А** и записать его в ячейку **по адресу 13**.

![[Pasted image 20231204040719.png]]
После выполнения всех инструкций мы получим следующий результат:

| Адрес | Данные     |     |
| ----- | ---------- | --- |
| 0     | Load_A 14  |     |
| 1     | Load_B 15  |     |
| 2     | Add B A    |     |
| 3     | Store_A 13 |     |
| 4     | 0          |     |
| 5     | 0          |     |
| 6     | 0          |     |
| 7     | 0          |     |
| 8     | 0          |     |
| 9     | 0          |     |
| 10    | 0          |     |
| 11    | 0          |     |
| 12    | 0          |     |
| 13    | 17         |     |
| 14    | 3          |     |
| 15    | 14         |     |
| ...   | ...        |     |

---
## Ссылки

1. [Что такое инструкции процессора?](https://www.upgradecenter.ru/company/articles/162686/#:~:text=Инструкции%20процессора%20–%20это%20набор,распознает%20и%20выполняет%20соответствующую%20операцию)
2. [Арифметико-логическое устройство](https://ru.wikipedia.org/wiki/Арифметико-логическое_устройство)

![Инструкции и программы. Видео](https://www.youtube.com/watch?v=zltgXvg6r3k)

![Как работает ALU. Видео](https://www.youtube.com/watch?v=1I5ZMmrOfnA&feature=youtu.be)

| [[Транзисторы в процессоре\|Предыдущая лекция]] | [[Шина адреса, данных и управления\|Следующая лекция]] |
| ----------------------------------------------- | ------------------------------------------------------ |
